@model SQ.CDT_SINAI.Web.Models.ViewModels.LoginViewModel
@using SQ.CDT_SINAI.Shared.Models

@{
    Layout = "_LayoutLogin";
    ViewData["Title"] = "Login";
}

<!-- Logo -->
<div class="login-logo">
    <a href="#">
        <b>SQ CDT SINAI</b><br>
        <span style="font-size: 0.8em; margin-left: 40px;">Sistema de Qualidade</span>
    </a>
</div>

<!-- Área de Notificação Anônima (Estilo Customizado) -->
<div class="card card-outline card-warning mb-3 anon-notification-card" data-toggle="modal" data-target="#modal-anonimo">
    <div class="card-body text-center p-2">
        <p class="mb-1 font-weight-bold text-dark">Notificação Anônima</p>
        <small class="text-muted">Clique aqui para notificar um incidente ou evento adverso de forma anônima.</small>
        <div class="mt-2">
            <i class="fas fa-user-secret fa-2x text-warning"></i>
        </div>
    </div>
</div>

<!-- Card de Login -->
<div class="card card-outline card-primary">
    <div class="card-body login-card-body">
        <p class="login-box-msg">Faça login para iniciar sua sessão</p>

        <form asp-action="Login" method="post">
            <div asp-validation-summary="ModelOnly" class="text-danger small mb-2"></div>

            <div class="input-group mb-3">
                <input asp-for="Email" class="form-control" placeholder="Email" />
                <div class="input-group-append">
                    <div class="input-group-text">
                        <span class="fas fa-envelope"></span>
                    </div>
                </div>
            </div>
            <span asp-validation-for="Email" class="text-danger small"></span>

            <div class="input-group mb-3">
                <input asp-for="Password" type="password" class="form-control" placeholder="Senha" id="passwordInput" />
                <div class="input-group-append">
                    <div class="input-group-text">
                        <span class="fas fa-lock"></span>
                    </div>
                </div>
            </div>
            <span asp-validation-for="Password" class="text-danger small"></span>

            <div class="row">
                <div class="col-8">
                    <div class="icheck-primary">
                        <input type="checkbox" id="remember">
                        <label for="remember">
                            Lembrar-me
                        </label>
                    </div>
                </div>
                <div class="col-4">
                    <button type="submit" class="btn btn-primary btn-block">ACESSAR</button>
                </div>
            </div>
        </form>

        <p class="mb-1 mt-3 text-center">
            <a href="#">Esqueci minha senha</a>
        </p>
    </div>
</div>

<div class="text-center mt-2 text-muted">
    <small>Versão 1.0</small>
</div>

<!-- Modal de Notificação Anônima -->
<div class="modal fade" id="modal-anonimo" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header bg-warning">
                <h5 class="modal-title">Atenção</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="formAnonimo">
                    <div class="form-group">
                        <label>Tipo de Cliente</label>
                        <select id="incClientType" class="form-control" asp-items="Html.GetEnumSelectList<ClientType>()"></select>
                    </div>

                    <div class="form-group">
                        <label>Meio de Contato</label>
                        <select id="incContactMethod" class="form-control" asp-items="Html.GetEnumSelectList<ContactMethod>()"></select>
                    </div>

                    <div class="form-group">
                        <label>Tipo de Ocorrência</label>
                        <select id="incCategory" class="form-control" asp-items="Html.GetEnumSelectList<IncidentCategory>()"></select>
                    </div>

                    <div class="form-group">
                        <label>Para quem é a ocorrência? (Médico/Setor)</label>
                        <input type="text" id="incTarget" class="form-control" placeholder="Ex: Dr. João ou Recepção" required />
                    </div>
                    
                    <div class="form-group">
                        <label>Gravidade (Prazo de Resposta)</label>
                        <select id="incSeverity" class="form-control">
                            <option value="0">Baixa (até 72h)</option>
                            <option value="1">Média (até 48h)</option>
                            <option value="2">Alta (até 24h)</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Descrição do Ocorrido</label>
                        <textarea id="incDescription" class="form-control" rows="3" required placeholder="Descreva o que aconteceu..."></textarea>
                    </div>

                    <hr />
                    <small class="text-muted">Seus dados (Opcional)</small>
                    <div class="row">
                        <div class="col-6">
                            <input type="text" id="incReporterName" class="form-control form-control-sm" placeholder="Seu Nome" />
                        </div>
                        <div class="col-6">
                            <input type="text" id="incReporterContact" class="form-control form-control-sm" placeholder="Contato (Tel/Email)" />
                        </div>
                    </div>
                </form>
                <div id="msgSuccess" class="alert alert-success mt-3" style="display:none;"></div>
                <div id="msgError" class="alert alert-danger mt-3" style="display:none;"></div>

                <div class="text-center mt-4" id="btnArea">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-warning" onclick="enviarOcorrencia()">Enviar Ocorrência</button>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function() {
            // Lembrar usuário e senha via localStorage
            if (localStorage.getItem('remember_email')) {
                $('#Email').val(localStorage.getItem('remember_email'));
                if (localStorage.getItem('remember_password')) {
                    $('#passwordInput').val(localStorage.getItem('remember_password'));
                }
                $('#remember').prop('checked', true);
            }

            $('form').submit(function() {
                if ($('#remember').is(':checked')) {
                    localStorage.setItem('remember_email', $('#Email').val());
                    localStorage.setItem('remember_password', $('#passwordInput').val());
                } else {
                    localStorage.removeItem('remember_email');
                    localStorage.removeItem('remember_password');
                }
            });
        });

        function enviarOcorrencia() {
            var data = {
                targetAreaOrProfessional: $('#incTarget').val(),
                severity: parseInt($('#incSeverity').val()),
                description: $('#incDescription').val(),
                reporterName: $('#incReporterName').val(),
                reporterContact: $('#incReporterContact').val(),
                clientType: parseInt($('#incClientType').val()),
                contactMethod: parseInt($('#incContactMethod').val()),
                category: parseInt($('#incCategory').val())
            };

            if(!data.targetAreaOrProfessional || !data.description) {
                alert("Preencha o destinatário e a descrição.");
                return;
            }

            // Desabilita botão
            $('#btnArea button').prop('disabled', true);

            // URL da API (ajuste a porta se necessário, aqui assume localhost:5001 via proxy ou direto)
            // Como estamos no browser, precisamos da URL completa da API
            var apiUrl = "http://localhost:5001/api/incident/external"; 

            fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            })
            .then(async response => {
                if (!response.ok) {
                    // Se der erro (ex: 400 Bad Request), lança exceção para cair no catch
                    throw new Error("Falha na requisição: " + response.statusText);
                }
                return response.json();
            })
            .then(result => {
                $('#formAnonimo').hide();
                $('#btnArea').hide();
                $('#msgSuccess').text(result.message || "Enviado com sucesso!").show();
            })
            .catch(error => {
                console.error(error);
                $('#msgError').text("Erro ao enviar. Verifique se a API está rodando e tente novamente.").show();
                $('#btnArea button').prop('disabled', false);
            });
        }
    </script>
}